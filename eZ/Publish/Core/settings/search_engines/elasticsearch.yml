imports:
    - {resource: search_engines/elasticsearch/criterion_visitors_common.yml}
    - {resource: search_engines/elasticsearch/criterion_visitors_content.yml}
    - {resource: search_engines/elasticsearch/criterion_visitors_location.yml}
    - {resource: search_engines/elasticsearch/facet_builder_visitors.yml}
    - {resource: search_engines/elasticsearch/field_value_mappers.yml}
    - {resource: search_engines/elasticsearch/services.yml}
    - {resource: search_engines/solr/slots.yml}
    - {resource: search_engines/elasticsearch/sort_clause_visitors_content.yml}
    - {resource: search_engines/elasticsearch/sort_clause_visitors_location.yml}

parameters:
    ezpublish.elasticsearch_server: http://localhost:9200/
    ezpublish.spi.search.elasticsearch.class: eZ\Publish\Core\Search\Elasticsearch\Handler
    ezpublish.search.elasticsearch.serializer.class: eZ\Publish\Core\Search\Elasticsearch\Content\Serializer
    ezpublish.search.elasticsearch.mapper.class: eZ\Publish\Core\Search\Elasticsearch\Content\Mapper
    ezpublish.search.elasticsearch.gateway.native.class: eZ\Publish\Core\Search\Elasticsearch\Content\Gateway\Native
    ezpublish.search.elasticsearch.location.gateway.native.class: eZ\Publish\Core\Search\Elasticsearch\Content\Location\Gateway\Native
    ezpublish.spi.search.elasticsearch.handler.content.class: eZ\Publish\Core\Search\Elasticsearch\Content\Handler
    ezpublish.spi.search.elasticsearch.handler.location.class: eZ\Publish\Core\Search\Elasticsearch\Content\Location\Handler
    ezpublish.search.elasticsearch.content.field_map.class: eZ\Publish\Core\Search\Elasticsearch\Content\FieldMap
    ezpublish.search.elasticsearch.extractor.loading.class: eZ\Publish\Core\Search\Elasticsearch\Content\Extractor\Loading

services:
    ezpublish.search.elasticsearch.serializer:
        class: %ezpublish.search.elasticsearch.serializer.class%
        arguments:
            - @ezpublish.search.elasticsearch.content.field_value_mapper.aggregate
            - @ezpublish.search.elasticsearch.content.field_name_generator

    ezpublish.search.elasticsearch.mapper:
        class: %ezpublish.search.elasticsearch.mapper.class%
        arguments:
            - @ezpublish.search.solr.field_registry
            - @ezpublish.search.elasticsearch.content.field_name_generator
            - @ezpublish.spi.persistence_handler.content
            - @ezpublish.spi.persistence_handler.location
            - @ezpublish.spi.persistence_handler.content_type
            - @ezpublish.spi.persistence_handler.object_state
            - @ezpublish.spi.persistence_handler.section

    ezpublish.search.elasticsearch.content.gateway.native:
        class: %ezpublish.search.elasticsearch.gateway.native.class%
        arguments:
            - @ezpublish.search.elasticsearch.content.gateway.client.http.stream
            - @ezpublish.search.elasticsearch.serializer
            - @ezpublish.search.elasticsearch.content.criterion_visitor_dispatcher
            - @ezpublish.search.elasticsearch.content.sort_clause_visitor.aggregate
            - @ezpublish.search.elasticsearch.content.facet_builder_visitor.aggregate

    ezpublish.search.elasticsearch.content.gateway:
        alias: ezpublish.search.elasticsearch.content.gateway.native

    ezpublish.search.elasticsearch.location.gateway.native:
        class: %ezpublish.search.elasticsearch.gateway.native.class%
        arguments:
            - @ezpublish.search.elasticsearch.content.gateway.client.http.stream
            - @ezpublish.search.elasticsearch.serializer
            - @ezpublish.search.elasticsearch.location.criterion_visitor_dispatcher
            - @ezpublish.search.elasticsearch.location.sort_clause_visitor.aggregate
            - @ezpublish.search.elasticsearch.content.facet_builder_visitor.aggregate

    ezpublish.search.elasticsearch.location.gateway:
        alias: ezpublish.search.elasticsearch.location.gateway.native

    ezpublish.search.elasticsearch.content.field_map:
        class: %ezpublish.search.elasticsearch.content.field_map.class%
        arguments:
            - @ezpublish.search.solr.field_registry
            - @ezpublish.spi.persistence_handler.content_type
            - @ezpublish.search.elasticsearch.content.field_name_generator

    # TODO: when Elasticsearch storage is enabled and multiple Elasticsearch storage engines are used simultaneously
    # this service will need to be set through factory, see https://jira.ez.no/browse/EZP-22846
    ezpublish.search.elasticsearch.content.field_map:
        alias: ezpublish.search.elasticsearch.content.field_map

    ezpublish.search.elasticsearch.extractor.loading:
        class: %ezpublish.search.elasticsearch.extractor.loading.class%
        arguments:
            - @ezpublish.spi.persistence_handler.content
            - @ezpublish.spi.persistence_handler.location
            - @ezpublish.search.elasticsearch.content.facet_builder_visitor.aggregate

    ezpublish.search.elasticsearch.extractor:
        alias: ezpublish.search.elasticsearch.extractor.loading

    ezpublish.spi.search.elasticsearch.handler.content:
        class: %ezpublish.spi.search.elasticsearch.handler.content.class%
        arguments:
            - @ezpublish.search.elasticsearch.content.gateway
            - @ezpublish.search.elasticsearch.mapper
            - @ezpublish.search.elasticsearch.extractor
        lazy: true

    ezpublish.spi.search.elasticsearch.handler.location:
        class: %ezpublish.spi.search.elasticsearch.handler.location.class%
        arguments:
            - @ezpublish.search.elasticsearch.location.gateway
            - @ezpublish.search.elasticsearch.mapper
            - @ezpublish.search.elasticsearch.extractor
        lazy: true

    ezpublish.spi.search.elasticsearch:
        class: %ezpublish.spi.search.elasticsearch.class%
        arguments:
            - @ezpublish.spi.search.elasticsearch.handler.content
            - @ezpublish.spi.search.elasticsearch.handler.location
        tags:
            - {name: ezpublish.searchEngine, alias: elasticsearch}
        lazy: true
